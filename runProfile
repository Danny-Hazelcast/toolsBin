#!/bin/bash

duration=$1
clusterSz=$2

boxCount=0
members=0
workers=0

case $clusterSz in
    test)
        boxCount=2
        members=2
        workers=2
        ;;

    small)
        boxCount=4
        members=4
        workers=8
        ;;

    medium)
        boxCount=6
        members=6
        workers=24
        ;;

    large)
        boxCount=10
        members=10
        workers=50
        ;;

    xlarge)
        boxCount=25
        members=25
        workers=100
        ;;

    *)
        echo "Unknown cluster size"
        exit 1
esac

if ! update-hazelcast ; then
   exit 1
fi

if ! update-stabilizer ; then
   exit 1
fi

mkdir -p ${clusterSz}

cp $SIMULATOR_HOME/stabilizer-tests/*.properties ${clusterSz}
cp ~/run.sh ${clusterSz}

cat ${clusterSz}/jcacheTest.properties >> ${clusterSz}/test.properties

output="$(pwd)/archive/$(date '+%Y_%m_%d-%H_%M_%S')"

cd ${clusterSz}

hzVersion=$(getHazelcastVersion)
sed -i s/maven=.*/maven="${hzVersion}"/g simulator.properties
./run.sh ${boxCount} ${members} ${workers} ${duration} ${output}

exit $?

